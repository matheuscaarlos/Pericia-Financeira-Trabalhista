<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento de Perícias - Perito</title>
    
    <!-- Carrega Tailwind CSS e Fontes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Inclui Font Awesome para ícones (necessário para o ícone do PIX e Edição) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* PALETA INSTITUCIONAL: ÍNDIGO (Primary) para branding e ações. Cores funcionais (Amber, Emerald, Red) mantidas para clareza de status. */
        :root {
            --primary-color: #4F46E5; /* Indigo 600 - Cor de Ação Principal/Institucional */
            --primary-color-dark: #4338CA; /* Indigo 700 - Hover */
            --pix-color: #F59E0B;     /* Amber 500 - Cor Funcional para Destaque Financeiro (PIX) */
            --success-color: #059669; /* Emerald 600 - Cor Funcional para Concluído/Sucesso */
            --danger-color: #DC2626;  /* Red 600 - Cor Funcional para Prazo Final/Perigo */
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Gray 100 */
            padding-bottom: 5rem; /* Espaço para a barra PIX fixa no rodapé */
        }

        /* Classes de Status */
        .status-Pendente { @apply bg-gray-400 text-gray-800; }
        .status-Em-Andamento { @apply bg-indigo-500 text-white; }
        .status-Aguardando-Resposta { @apply bg-amber-500 text-gray-900; }
        .status-Concluido { @apply bg-emerald-600 text-white; }
        .status-Atrasado { @apply bg-red-600 text-white; }
        
        /* Classes de Destaque para Tipo de Perícia */
        .type-Cível { @apply bg-blue-100 text-blue-800; }
        .type-Trabalhista { @apply bg-red-100 text-red-800; }
        .type-Previdenciária { @apply bg-green-100 text-green-800; }
        .type-Financeira { @apply bg-teal-100 text-teal-800; } 
        .type-Outro { @apply bg-purple-100 text-purple-800; }

        /* Chaveframes para o Efeito Pulsante PIX */
        @keyframes pulse-pix {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); /* Cor Amber 500 com opacidade */
            }
            50% {
                box-shadow: 0 0 0 10px rgba(245, 158, 11, 0);
            }
        }
        .pulsing-pix {
            animation: pulse-pix 2s infinite;
        }

        /* Chaveframes e Classe para o Alerta de Prazo Próximo/Atrasado (Pulsar Vermelho) */
        @keyframes deadline-pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.5); /* Cor Red 600 com opacidade */
            }
            50% {
                box-shadow: 0 0 0 5px rgba(220, 38, 38, 0);
            }
        }
        .deadline-alert {
            animation: deadline-pulse 1.5s infinite;
            border-color: var(--danger-color) !important; 
            border-left-width: 6px !important; /* Aumenta a espessura da borda esquerda para destaque */
        }

        /* NOVO: Chaveframes e Classe para o Prazo Seguro (Pulsar Verde) */
        @keyframes safe-pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(5, 150, 105, 0.4); /* Cor Emerald 600 com opacidade */
            }
            50% {
                box-shadow: 0 0 0 8px rgba(5, 150, 105, 0);
            }
        }
        .safe-deadline-pulse {
            animation: safe-pulse 2s ease-out infinite;
            border-color: var(--success-color) !important; 
            border-left-width: 6px !important;
        }
    </style>
</head>
<body onload="initApp()">

    <!-- Header Principal -->
    <header class="bg-white shadow-md">
        <!-- AQUI: Usamos grid com 3 colunas para centralizar o H1 e manter o botão à direita -->
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 grid grid-cols-3 items-center">
            
            <!-- Coluna 1: Espaçador Vazio para Alinhamento -->
            <div></div> 

            <!-- Coluna 2: Título Principal Centralizado -->
            <h1 class="text-2xl font-extrabold text-gray-900 text-center">
                Monitoramento de Perícias
            </h1>
            
            <!-- Coluna 3: Botão de Sair Alinhado à Direita -->
            <div class="flex justify-end">
                <button onclick="handleLogout()" class="bg-[var(--primary-color)] hover:bg-[var(--primary-color-dark)] text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150">
                    Sair
                </button>
            </div>
        </div>
    </header>

    <!-- Conteúdo Principal -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        
        <!-- Dashboard de Credenciais -->
        <div id="credentialsContainer" class="bg-white overflow-hidden shadow rounded-lg mb-6 p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Minhas Credenciais</h2>
                <!-- NOVO BOTÃO DE EDIÇÃO DE CREDENCIAIS -->
                <button onclick="handleOpenCredentialsModal()" 
                        class="text-[var(--primary-color)] hover:text-[var(--primary-color-dark)] p-2 rounded-full transition duration-150"
                        title="Editar Credenciais">
                    <i class="fas fa-edit"></i>
                </button>
            </div>
            <!-- Conteúdo será preenchido por renderCredentials() -->
            <div id="credentialsDisplay" class="space-y-3">
                <p class="text-gray-500">Carregando credenciais...</p>
            </div>
        </div>

        <!-- Seção de Adicionar Novo Processo -->
        <div class="bg-white overflow-hidden shadow rounded-lg mb-6 p-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Adicionar Novo Processo</h2>
            <!-- AJUSTE DE LAYOUT: Limita a largura do formulário em telas grandes para ser mais compacto (max-w-sm = 384px) -->
            <div class="max-w-sm mx-auto"> 
                <form id="addProcessForm" onsubmit="event.preventDefault(); handleAddProcess(event);" class="space-y-4">
                    
                    <!-- Número do Processo (Validação - Full Width) -->
                    <div>
                        <label for="inputProcessNumber" class="block text-sm font-medium text-gray-700">Número do Processo (CNJ)</label>
                        <input type="text" id="inputProcessNumber" placeholder="Ex: 0001234-56.2023.8.26.0001" 
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)]" 
                            required maxlength="25">
                        <p id="processId" class="mt-1 text-xs text-gray-500 hidden">ID Gerado: <span></span></p>
                        <p id="duplicityError" class="mt-1 text-sm text-red-600 hidden font-semibold">Este número de processo já foi cadastrado.</p>
                    </div>

                    <!-- NOVO GRUPO: Autor(a) e Réu (2 COLUNAS) -->
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Autor(a) -->
                        <div>
                            <label for="inputAuthor" class="block text-sm font-medium text-gray-700">Autor(a)</label>
                            <input type="text" id="inputAuthor" placeholder="Autor" 
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)]" 
                                required>
                        </div>

                        <!-- Réu -->
                        <div>
                            <label for="inputDefendant" class="block text-sm font-medium text-gray-700">Réu</label>
                            <input type="text" id="inputDefendant" placeholder="Réu" 
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)]" 
                                required>
                        </div>
                    </div>

                    <!-- Tipo de Perícia (Full Width) -->
                    <div>
                        <label for="processType" class="block text-sm font-medium text-gray-700">Tipo de Perícia</label>
                        <select id="processType" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)]" required>
                            <option value="">Selecione o Tipo</option>
                            <option value="Cível">Cível</option>
                            <option value="Trabalhista">Trabalhista</option>
                            <option value="Previdenciária">Previdenciária</option>
                            <option value="Financeira">Financeira</option> 
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    
                    <!-- NOVO GRUPO: Data de Nomeação e Prazo (2 COLUNAS) -->
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Data de Nomeação (Nomeação) -->
                        <div>
                            <label for="inputDateNomination" class="block text-sm font-medium text-gray-700">Nomeação</label>
                            <input type="date" id="inputDateNomination"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)]">
                        </div>

                        <!-- Prazo para Entrega de Laudo (Prazo Laudo) -->
                        <div>
                            <label for="inputDateDeadline" class="block text-sm font-medium text-gray-700">Prazo Laudo</label>
                            <input type="date" id="inputDateDeadline"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)]">
                        </div>
                    </div>
                    
                    <!-- Observações (Full Width) -->
                    <div>
                        <label for="inputObservations" class="block text-sm font-medium text-gray-700">Observações</label>
                        <textarea id="inputObservations" rows="3" placeholder="Informações adicionais sobre o processo..."
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)]"></textarea>
                    </div>

                    <!-- Botão de Submissão (Full Width) -->
                    <button type="submit" id="processSubmitButton" disabled 
                            class="w-full bg-gray-400 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150 disabled:opacity-50">
                        Adicionar Processo
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Filtros e Busca -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Filtrar Processos</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <!-- Filtro por Tipo -->
                <div>
                    <label for="filterType" class="block text-sm font-medium text-gray-700">Tipo</label>
                    <select id="filterType" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <option value="Todos">Todos os Tipos</option>
                        <option value="Cível">Cível</option>
                        <option value="Trabalhista">Trabalhista</option>
                        <option value="Previdenciária">Previdenciária</option>
                        <option value="Financeira">Financeira</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>

                <!-- Filtro por Status -->
                <div>
                    <label for="filterStatus" class="block text-sm font-medium text-gray-700">Status</label>
                    <select id="filterStatus" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <option value="Todos">Todos os Status</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Aguardando Resposta">Aguardando Resposta</option>
                        <option value="Concluído">Concluído</option>
                        <option value="Atrasado">Atrasado</option>
                    </select>
                </div>
                
                <!-- Campo de Busca -->
                <div>
                    <label for="searchQuery" class="block text-sm font-medium text-gray-700">Buscar por Número</label>
                    <input type="text" id="searchQuery" placeholder="Buscar..." 
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
            </div>
        </div>

        <!-- Lista de Processos -->
        <div id="processListContainer" class="space-y-4">
            <!-- Os cards de processo serão inseridos aqui -->
        </div>
        
        <!-- Mensagem de Sem Processos -->
        <div id="noProcessesMessage" class="bg-amber-100 border-l-4 border-amber-500 text-amber-700 p-4 rounded-lg hidden" role="alert">
            <p class="font-bold">Nenhum Processo Encontrado</p>
            <p>Não há processos cadastrados ou nenhum corresponde aos filtros atuais.</p>
        </div>

    </main>
    
    <!-- Modal de Edição de Processo -->
    <div id="editProcessModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl p-6 transform transition-all duration-300 scale-100">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4">Editar Processo <span id="modalProcessNumber" class="text-indigo-600"></span></h2>
            
            <form id="editProcessForm" onsubmit="event.preventDefault(); handleUpdateProcess(event);" class="space-y-4">
                
                <input type="hidden" id="editProcessId">
                
                <!-- Autor (Editável) -->
                <div>
                    <label for="editAuthor" class="block text-sm font-medium text-gray-700">Autor(a)</label>
                    <input type="text" id="editAuthor" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- Réu (Editável) -->
                <div>
                    <label for="editDefendant" class="block text-sm font-medium text-gray-700">Réu</label>
                    <input type="text" id="editDefendant" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- Status Atual (Editável) -->
                <div>
                    <label for="editStatus" class="block text-sm font-medium text-gray-700">Status Atual</label>
                    <select id="editStatus" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                        <option value="Pendente">Pendente</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Aguardando Resposta">Aguardando Resposta</option>
                        <option value="Concluído">Concluído</option>
                        <option value="Atrasado">Atrasado</option>
                    </select>
                </div>
                
                <!-- Data de Nomeação -->
                <div>
                    <label for="editDateNomination" class="block text-sm font-medium text-gray-700">Data de Nomeação</label>
                    <input type="date" id="editDateNomination"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- Prazo para Entrega de Laudo -->
                <div>
                    <label for="editDateDeadline" class="block text-sm font-medium text-gray-700">Prazo para Entrega de Laudo</label>
                    <input type="date" id="editDateDeadline"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- Observações -->
                <div>
                    <label for="editObservations" class="block text-sm font-medium text-gray-700">Observações</label>
                    <textarea id="editObservations" rows="3" placeholder="Informações adicionais sobre o processo..."
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <!-- Botões de Ação -->
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="handleCloseModal()"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                        Cancelar
                    </button>
                    <button type="submit"
                            class="px-4 py-2 text-sm font-medium text-white bg-[var(--primary-color)] rounded-lg hover:bg-[var(--primary-color-dark)] transition duration-150">
                        Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- NOVO: Modal de Edição de Credenciais -->
    <div id="editCredentialsModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all duration-300 scale-100">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4">Editar Minhas Credenciais</h2>
            
            <form id="editCredentialsForm" onsubmit="event.preventDefault(); handleUpdateCredentials(event);" class="space-y-4">
                
                <!-- Nome do Perito -->
                <div>
                    <label for="editCredentialName" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                    <input type="text" id="editCredentialName" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- Registro (CRC/CRA/Outro) -->
                <div>
                    <label for="editCredentialRegistry" class="block text-sm font-medium text-gray-700">Registro (CRC/CRA/Outro)</label>
                    <input type="text" id="editCredentialRegistry" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <!-- Botões de Ação -->
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="handleCloseCredentialsModal()"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                        Cancelar
                    </button>
                    <button type="submit"
                            class="px-4 py-2 text-sm font-medium text-white bg-[var(--primary-color)] rounded-lg hover:bg-[var(--primary-color-dark)] transition duration-150">
                        Salvar Credenciais
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Barra de Apoio PIX Fixa no Fundo (NOVA SEÇÃO) -->
    <div id="pixBar" class="fixed bottom-0 left-0 w-full bg-indigo-800 p-3 shadow-2xl z-50 transition-transform duration-300">
        <div class="max-w-7xl mx-auto flex flex-col sm:flex-row items-center justify-between space-y-2 sm:space-y-0 sm:space-x-4">
            <p class="text-white text-sm font-medium text-center sm:text-left">
                Apoie o desenvolvimento deste projeto via PIX. Sua contribuição é muito importante!
            </p>
            <div class="flex items-center space-x-2">
                <!-- Botão Pulsante para Copiar Chave - CLICAR COPIA A CHAVE -->
                <button id="copyPixKey" onclick="copyPixKey()" 
                        class="bg-amber-500 hover:bg-amber-600 text-indigo-900 font-extrabold py-2 px-4 rounded-full pulsing-pix transition duration-150 active:scale-95 text-xs sm:text-sm shadow-lg focus:outline-none focus:ring-4 focus:ring-amber-300"
                        title="Clique para copiar a chave PIX">
                    <i class="fas fa-qrcode mr-2"></i> Chave PIX: matheuscaarlos09@gmail.com
                </button>
                <!-- Mensagem de Confirmação (será exibida via JS) -->
                <div id="copyMessage" class="hidden text-sm text-green-300 font-bold"></div>
            </div>
        </div>
    </div>


    <script>
        // Chaves para o localStorage
        const PROCESSES_STORAGE_KEY = 'pericias_processes_v1';
        const CREDENTIALS_STORAGE_KEY = 'pericias_credentials_v1';
        const PIX_KEY = "matheuscaarlos09@gmail.com"; // Chave PIX centralizada

        // Variáveis de estado global (substituem o Firebase)
        let processes = [];
        let credentials = {};
        
        // Referências DOM - Declaradas aqui para acesso global
        let processListContainer, noProcessesMessage, credentialsDisplay, filterTypeEl, filterStatusEl, searchQueryEl;
        
        // CAMPOS DO FORMULÁRIO DE CADASTRO
        let inputProcessNumberEl, processIdEl, duplicityErrorEl, processSubmitButtonEl;
        let inputAuthorEl, inputDefendantEl; 
        
        // REFERÊNCIAS DOM DO MODAL DE EDIÇÃO DE PROCESSO
        let editProcessModal, editProcessIdEl, modalProcessNumberEl, editStatusEl, editDateNominationEl, editDateDeadlineEl, editObservationsEl;
        let editAuthorEl, editDefendantEl; 

        // NOVO: REFERÊNCIAS DOM DO MODAL DE EDIÇÃO DE CREDENCIAIS
        let editCredentialsModal, editCredentialNameEl, editCredentialRegistryEl;


        // ------------------
        // FUNÇÕES DE UTILIDADE (LOCAL STORAGE)
        // ------------------
        
        /**
         * Carrega a lista de processos do localStorage.
         */
        function getProcessesFromLocalStorage() {
            try {
                const stored = localStorage.getItem(PROCESSES_STORAGE_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                console.error("Erro ao carregar processos do localStorage:", e);
                return [];
            }
        }

        /**
         * Salva a lista de processos no localStorage.
         * @param {Array<Object>} data - Array de processos.
         */
        function saveProcessesToLocalStorage(data) {
            try {
                localStorage.setItem(PROCESSES_STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error("Erro ao salvar processos no localStorage:", e);
            }
        }

        /**
         * Carrega as credenciais do localStorage.
         */
        function getCredentialsFromLocalStorage() {
            try {
                const stored = localStorage.getItem(CREDENTIALS_STORAGE_KEY);
                // ATUALIZADO: Default ajustado para CRA
                return stored ? JSON.parse(stored) : {
                    nome: "Perito(a) Designado(a)",
                    registro: "CRC/CRA 123456", 
                    dataAtualizacao: new Date().toLocaleDateString('pt-BR')
                };
            } catch (e) {
                console.error("Erro ao carregar credenciais do localStorage:", e);
                return {};
            }
        }

        /**
         * Salva as credenciais no localStorage.
         * @param {Object} data - Objeto de credenciais.
         */
        function saveCredentialsToLocalStorage(data) {
            try {
                localStorage.setItem(CREDENTIALS_STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error("Erro ao salvar credenciais no localStorage:", e);
            }
        }


        /**
         * Formata o número do processo CNJ (Ex: 0001234-56.2023.8.26.0001) para um ID de documento.
         * Remove caracteres não alfanuméricos.
         * @param {string} cnjNumber - O número do processo no formato CNJ.
         * @returns {string} ID formatado.
         */
        function formatProcessToId(cnjNumber) {
            return cnjNumber.replace(/[^a-zA-Z0-9]/g, '');
        }

        /**
         * Retorna a classificação do prazo de entrega: 'Safe', 'Near', 'Overdue' ou 'None'.
         * @param {object} process - O objeto do processo.
         * @returns {string} A classificação do prazo.
         */
        function getDeadlineStatus(process) {
            if (!process.prazoEntrega || process.status === 'Concluído') {
                return 'None';
            }

            // Garante que a data seja interpretada corretamente como UTC (meia-noite)
            const deadlineDate = new Date(process.prazoEntrega + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const diffTime = deadlineDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

            const NEAR_DEADLINE_THRESHOLD = 7; // 7 dias

            if (diffDays < 0) {
                return 'Overdue';
            } else if (diffDays <= NEAR_DEADLINE_THRESHOLD) {
                return 'Near';
            } else {
                return 'Safe';
            }
        }


        // ------------------
        // FUNÇÃO PIX (AGORA COM COPIA PARA ÁREA DE TRANSFERÊNCIA)
        // ------------------

        /**
         * Copia a chave PIX para a área de transferência e mostra uma mensagem de sucesso.
         */
        window.copyPixKey = function() {
            const key = PIX_KEY; // Usa a constante PIX_KEY
            
            // 1. Cria um elemento temporário para copiar o texto
            const tempInput = document.createElement('input');
            tempInput.value = key;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            const copyMessageEl = document.getElementById('copyMessage');
            const buttonEl = document.getElementById('copyPixKey');
            const originalButtonText = '<i class="fas fa-qrcode mr-2"></i> Chave PIX: matheuscaarlos09@gmail.com';

            try {
                // 2. Tenta copiar (document.execCommand('copy') é o fallback mais seguro em iframes)
                const successful = document.execCommand('copy');

                if (successful) {
                    // 3. Feedback visual de sucesso
                    buttonEl.classList.remove('pulsing-pix'); // Para o pulso durante a cópia
                    buttonEl.classList.add('bg-emerald-500', 'hover:bg-emerald-500'); // Cor de sucesso
                    buttonEl.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Copiado! (Clique p/ restaurar)'; // Texto de sucesso
                    
                    // Exibe a mensagem de sucesso
                    copyMessageEl.textContent = 'Chave Copiada! ✅';
                    copyMessageEl.classList.remove('hidden', 'text-red-300');
                    copyMessageEl.classList.add('block', 'text-green-300');

                    // 4. Restaura o estado após um tempo
                    setTimeout(() => {
                        copyMessageEl.classList.add('hidden');
                        buttonEl.classList.remove('bg-emerald-500', 'hover:bg-emerald-500');
                        buttonEl.classList.add('bg-amber-500', 'hover:bg-amber-600', 'pulsing-pix');
                        buttonEl.innerHTML = originalButtonText;
                    }, 3000);

                } else {
                    // Feedback de falha
                    console.error('Falha ao copiar.');
                    copyMessageEl.textContent = 'Falha ao copiar. Tente novamente.';
                    copyMessageEl.classList.remove('hidden', 'text-green-300');
                    copyMessageEl.classList.add('block', 'text-red-300');
                    setTimeout(() => {
                        copyMessageEl.classList.add('hidden');
                    }, 3000);
                }
            } catch (err) {
                console.error('Erro ao usar execCommand:', err);
            } finally {
                // 5. Remove o input temporário
                document.body.removeChild(tempInput);
            }
        }

        // ------------------
        // FUNÇÕES DE EDIÇÃO DE PROCESSO (MODAL)
        // ------------------

        /**
         * Fecha o modal de edição de processo.
         */
        window.handleCloseModal = function() {
            if (editProcessModal) {
                editProcessModal.classList.add('hidden');
                editProcessModal.classList.remove('flex');
            }
        }

        /**
         * Abre o modal de edição de processo e carrega os dados do processo.
         * @param {string} id - O ID formatado do processo.
         */
        window.handleEditProcess = function(id) {
            const process = processes.find(p => p.id === id);
            if (process) {
                // Preenche campos do modal
                editProcessIdEl.value = process.id;
                modalProcessNumberEl.textContent = process.cnjNumber;
                
                // Preenche Autor e Réu
                editAuthorEl.value = process.author || '';
                editDefendantEl.value = process.defendant || '';

                // Configura o status
                editStatusEl.value = process.status || 'Pendente';
                
                // Preenche datas (usa '' se null)
                editDateNominationEl.value = process.dataNomeacao || '';
                editDateDeadlineEl.value = process.prazoEntrega || '';
                editObservationsEl.value = process.observacoes || '';

                // Exibe o modal
                editProcessModal.classList.remove('hidden');
                editProcessModal.classList.add('flex'); // Usa flex para centralizar
            } else {
                console.error("Processo não encontrado para edição.");
            }
        }

        /**
         * Salva as alterações de um processo no localStorage.
         */
        window.handleUpdateProcess = function(event) {
            const id = editProcessIdEl.value;
            const processIndex = processes.findIndex(p => p.id === id);
            
            if (processIndex === -1) {
                console.error("Processo não encontrado para atualização local.");
                return;
            }

            const newStatus = editStatusEl.value;
            const newNomination = editDateNominationEl.value;
            const newDeadline = editDateDeadlineEl.value;
            const newObservations = editObservationsEl.value.trim();
            const newAuthor = editAuthorEl.value.trim();      
            const newDefendant = editDefendantEl.value.trim(); 

            if (!id || !newStatus || !newAuthor || !newDefendant) {
                console.error("ID, Status, Autor ou Réu faltando para a atualização.");
                return;
            }

            // Atualiza o objeto no array
            processes[processIndex] = {
                ...processes[processIndex],
                // Partes do Processo
                author: newAuthor,
                defendant: newDefendant,
                status: newStatus,
                dataNomeacao: newNomination || null,
                prazoEntrega: newDeadline || null,
                observacoes: newObservations,
                ultimaAtualizacao: new Date().toISOString(),
            };

            // Salva no localStorage e renderiza novamente
            saveProcessesToLocalStorage(processes);
            renderProcesses();
            
            console.log(`Processo ${id} atualizado localmente com sucesso!`);
            handleCloseModal(); // Feche o modal após o sucesso
        }
        
        // ------------------
        // FUNÇÕES DE EDIÇÃO DE CREDENCIAIS (NOVO MODAL)
        // ------------------

        /**
         * Abre o modal de edição de credenciais e preenche os campos.
         */
        window.handleOpenCredentialsModal = function() {
            if (!editCredentialsModal) return;

            // Preenche os campos com os dados atuais
            editCredentialNameEl.value = credentials.nome || '';
            editCredentialRegistryEl.value = credentials.registro || '';

            // Exibe o modal
            editCredentialsModal.classList.remove('hidden');
            editCredentialsModal.classList.add('flex');
        }

        /**
         * Fecha o modal de edição de credenciais.
         */
        window.handleCloseCredentialsModal = function() {
            if (editCredentialsModal) {
                editCredentialsModal.classList.add('hidden');
                editCredentialsModal.classList.remove('flex');
            }
        }

        /**
         * Salva as novas credenciais no localStorage.
         */
        window.handleUpdateCredentials = function(event) {
            const newName = editCredentialNameEl.value.trim();
            const newRegistry = editCredentialRegistryEl.value.trim();

            if (!newName || !newRegistry) {
                console.error("Nome e Registro são obrigatórios.");
                return;
            }

            credentials = {
                nome: newName,
                registro: newRegistry,
                dataAtualizacao: new Date().toLocaleDateString('pt-BR'),
            };

            saveCredentialsToLocalStorage(credentials);
            renderCredentials();

            console.log("Credenciais atualizadas localmente com sucesso!");
            handleCloseCredentialsModal();
        }


        // ------------------
        // CARREGAMENTO DE DADOS (LOCAL STORAGE)
        // ------------------

        /**
         * Carrega as credenciais do usuário do localStorage.
         */
        function loadCredentials() {
            credentials = getCredentialsFromLocalStorage();
            // Se as credenciais estiverem vazias, o getCredentialsFromLocalStorage já fornece um default.
            if (Object.keys(credentials).length === 0) {
                 credentials = {
                    nome: "Perito(a) Designado(a)",
                    registro: "CRC/CRA 123456", 
                    dataAtualizacao: new Date().toLocaleDateString('pt-BR')
                };
                saveCredentialsToLocalStorage(credentials);
            }
        }

        /**
         * Renderiza as credenciais na tela.
         */
        function renderCredentials() {
            if (!credentialsDisplay) return;

            if (Object.keys(credentials).length > 0) {
                credentialsDisplay.innerHTML = `
                    <p class="text-lg font-semibold text-indigo-600">${credentials.nome || 'N/A'}</p>
                    <p class="text-gray-600">Registro: ${credentials.registro || 'N/A'}</p>
                    <p class="text-sm text-gray-500">Última atualização: ${credentials.dataAtualizacao || 'N/A'}</p>
                `;
            } else {
                credentialsDisplay.innerHTML = '<p class="text-gray-500">Nenhuma credencial encontrada. Edite acima para salvar.</p>';
            }
        }
        
        /**
         * Realiza a validação em tempo real do Número do Processo.
         */
        function validateProcessNumber() {
            if (!inputProcessNumberEl || !processSubmitButtonEl || !duplicityErrorEl) return;
            
            const cnjNumber = inputProcessNumberEl.value.trim();
            const processId = formatProcessToId(cnjNumber);
            
            const isDuplicate = processes.some(p => p.id === processId);
            const isValidFormat = cnjNumber.length >= 10; // Validação básica

            // 1. Mostrar ID (para debug/contexto)
            const processIdSpan = processIdEl?.querySelector('span');
            if (processIdSpan) {
                processIdSpan.textContent = processId;
                processIdEl.classList.remove('hidden');
            }

            // 2. Erro de Duplicidade ou Formato Inválido
            if (isDuplicate) {
                duplicityErrorEl.textContent = 'Este número de processo já foi cadastrado.';
                duplicityErrorEl.classList.remove('hidden');
                processSubmitButtonEl.disabled = true;
                processSubmitButtonEl.classList.remove('bg-[var(--primary-color)]', 'hover:bg-[var(--primary-color-dark)]');
                processSubmitButtonEl.classList.add('bg-gray-400');
            } else if (!isValidFormat) {
                duplicityErrorEl.textContent = 'Número do processo muito curto.';
                duplicityErrorEl.classList.remove('hidden');
                processSubmitButtonEl.disabled = true;
                processSubmitButtonEl.classList.remove('bg-[var(--primary-color)]', 'hover:bg-[var(--primary-color-dark)]');
                processSubmitButtonEl.classList.add('bg-gray-400');
            } 
            else {
                duplicityErrorEl.classList.add('hidden');
                processSubmitButtonEl.disabled = false;
                processSubmitButtonEl.classList.remove('bg-gray-400');
                processSubmitButtonEl.classList.add('bg-[var(--primary-color)]', 'hover:bg-[var(--primary-color-dark)]');
            }
        }


        /**
         * Adiciona um novo processo ao array e salva no localStorage.
         */
        window.handleAddProcess = function(event) {
            const cnjNumber = document.getElementById('inputProcessNumber').value.trim();
            const author = document.getElementById('inputAuthor').value.trim();       
            const defendant = document.getElementById('inputDefendant').value.trim(); 
            const processType = document.getElementById('processType').value;
            const dateNomination = document.getElementById('inputDateNomination').value; 
            const dateDeadline = document.getElementById('inputDateDeadline').value;     
            const observations = document.getElementById('inputObservations').value.trim(); 
            
            const processId = formatProcessToId(cnjNumber);

            if (!cnjNumber || !processType || !author || !defendant) {
                console.error("Campos obrigatórios (Número, Tipo, Autor, Réu) faltando.");
                return;
            }

            // Garante que não é duplicado
            if (processes.some(p => p.id === processId)) {
                console.warn("Processo já cadastrado.");
                return;
            }

            const newProcess = {
                id: processId,
                cnjNumber: cnjNumber,
                
                // Partes do Processo
                author: author,
                defendant: defendant,
                
                type: processType,
                status: 'Pendente', // Status inicial
                dataCriacao: new Date().toISOString(),
                ultimaAtualizacao: new Date().toISOString(),
                
                // DATAS/OBS
                dataNomeacao: dateNomination || null, 
                prazoEntrega: dateDeadline || null,   
                observacoes: observations,
            };

            // Adiciona ao array e salva localmente
            processes.push(newProcess);
            saveProcessesToLocalStorage(processes);
            renderProcesses(); // Renderiza para simular atualização em tempo real

            // Limpa o formulário
            event.target.reset();
            validateProcessNumber(); // Reseta o estado do botão/validação
            console.log("Processo adicionado localmente com sucesso!");
        }

        /**
         * Renderiza a lista de processos com base nos filtros.
         */
        function renderProcesses() {
            if (!processListContainer || !noProcessesMessage) return;

            const filterType = filterTypeEl.value;
            const filterStatus = filterStatusEl.value;
            const searchQuery = searchQueryEl.value.toLowerCase();
            
            let filteredProcesses = processes;

            // Funcao auxiliar para formatar data (robustez para YYYY-MM-DD do input date)
            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                try {
                    // Tenta criar um objeto Date. Se for YYYY-MM-DD, adiciona 'T00:00:00' para evitar fuso horário
                    const date = new Date(dateString.includes('T') ? dateString : dateString + 'T00:00:00');
                    if (isNaN(date.getTime())) return 'Inválida';

                    return date.toLocaleDateString('pt-BR');
                } catch (e) {
                    return 'Erro';
                }
            }


            // 1. Aplica filtros
            if (filterType !== 'Todos') {
                filteredProcesses = filteredProcesses.filter(p => p.type === filterType);
            }
            if (filterStatus !== 'Todos') {
                filteredProcesses = filteredProcesses.filter(p => p.status === filterStatus);
            }
            if (searchQuery) {
                filteredProcesses = filteredProcesses.filter(p => 
                    p.cnjNumber.toLowerCase().includes(searchQuery) ||
                    p.author.toLowerCase().includes(searchQuery) ||
                    p.defendant.toLowerCase().includes(searchQuery)
                );
            }
            
            // 2. Ordenação por Prazo (os mais próximos/atrasados no topo)
            filteredProcesses.sort((a, b) => {
                const dateA = a.prazoEntrega ? new Date(a.prazoEntrega + 'T00:00:00').getTime() : Infinity;
                const dateB = b.prazoEntrega ? new Date(b.prazoEntrega + 'T00:00:00').getTime() : Infinity;

                // Ordena crescentemente pelo prazo (o prazo mais próximo vem primeiro)
                return dateA - dateB; 
            });


            processListContainer.innerHTML = '';
            
            if (filteredProcesses.length === 0) {
                processListContainer.classList.add('hidden');
                noProcessesMessage.classList.remove('hidden');
                return;
            }

            processListContainer.classList.remove('hidden');
            noProcessesMessage.classList.add('hidden');

            filteredProcesses.forEach(process => {
                const dataNomeacao = process.dataNomeacao;
                const prazoEntrega = process.prazoEntrega;
                
                // Determina a classe de urgência (Vermelho ou Verde)
                const deadlineStatus = getDeadlineStatus(process);
                let urgencyClass = '';

                if (deadlineStatus === 'Near' || deadlineStatus === 'Overdue') {
                    // Prazo próximo ou atrasado (Vermelho/Alerta)
                    urgencyClass = 'deadline-alert'; 
                } else if (deadlineStatus === 'Safe') {
                    // Prazo seguro (Verde/Pulsante)
                    urgencyClass = 'safe-deadline-pulse';
                }

                const prazoInfo = prazoEntrega ? 
                    `<span class="text-sm font-medium ${deadlineStatus === 'Overdue' ? 'text-red-600 font-bold' : deadlineStatus === 'Safe' ? 'text-emerald-600' : 'text-amber-500'}">Prazo: ${formatDate(prazoEntrega)}</span>` : 
                    `<span class="text-sm text-gray-500">Prazo Não Definido</span>`;
                
                const nomeacaoInfo = dataNomeacao ? 
                    `<p class="text-xs text-gray-500">Nomeação: ${formatDate(dataNomeacao)}</p>` :
                    `<p class="text-xs text-gray-500">Nomeação: N/A</p>`;

                // Classe para destaque do Tipo
                const typeClass = `type-${process.type.replace(/\s/g, '-')}`;

                
                const processCard = `
                    <div class="bg-white p-5 rounded-xl shadow-lg border-l-4 border-[var(--primary-color)] hover:shadow-xl transition duration-200 ${urgencyClass}">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <div class="mb-2 sm:mb-0">
                                <h3 class="text-lg font-bold text-gray-800">${process.cnjNumber}</h3>
                                <!-- Badge de destaque para o Tipo -->
                                <span class="inline-flex items-center px-3 py-0.5 rounded-full text-xs font-medium mt-1 ${typeClass}">
                                    ${process.type}
                                </span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="text-xs font-semibold px-3 py-1 rounded-full ${'status-' + process.status.replace(/\s/g, '-')}" >
                                    ${process.status}
                                </span>
                                <!-- Botão de Edição -->
                                <button onclick="handleEditProcess('${process.id}')" 
                                        class="bg-indigo-100 text-[var(--primary-color)] hover:bg-indigo-200 p-2 rounded-full transition duration-150"
                                        title="Editar Processo">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Seção de Partes do Processo -->
                        <div class="mt-3 text-sm text-gray-700 border-t pt-3">
                            <p class="ml-0 text-xs font-semibold text-gray-800">Partes:</p>
                            <p class="ml-2 mt-1">
                                <span class="font-medium text-indigo-600">Autor:</span> ${process.author || 'N/A'} 
                                <span class="mx-2 text-gray-400 hidden sm:inline">|</span> 
                                <span class="font-medium text-red-600">Réu:</span> ${process.defendant || 'N/A'}
                            </p>
                        </div>

                        <!-- Linha de Nomeação e Atualização -->
                        <div class="mt-3 border-t pt-3 flex justify-between items-center">
                            ${nomeacaoInfo}
                            <p class="text-xs text-gray-400">Atualizado: ${formatDate(process.ultimaAtualizacao)}</p>
                        </div>
                        <!-- Linha de Prazo -->
                        <div class="mt-1 flex justify-start">
                            ${prazoInfo}
                        </div>
                    </div>
                `;
                processListContainer.insertAdjacentHTML('beforeend', processCard);
            });
        }
        
        /**
         * Carrega a lista de processos do localStorage para a memória.
         */
        function loadProcesses() {
            processes = getProcessesFromLocalStorage();
            renderProcesses();
        }
        
        /**
         * Função placeholder para logout (simplesmente recarrega a página).
         */
        window.handleLogout = function() {
            console.log('Dados salvos localmente. A funcionalidade de "Sair" apenas recarrega a página no modo Local Storage.');
            window.location.reload(); 
        }

        // ------------------
        // INICIALIZAÇÃO DA APLICAÇÃO
        // ------------------
        
        function initApp() {
            
            // 1. Obtém referências DOM
            processListContainer = document.getElementById('processListContainer');
            noProcessesMessage = document.getElementById('noProcessesMessage');
            credentialsDisplay = document.getElementById('credentialsDisplay');
            filterTypeEl = document.getElementById('filterType');
            filterStatusEl = document.getElementById('filterStatus');
            searchQueryEl = document.getElementById('searchQuery');
            
            inputProcessNumberEl = document.getElementById('inputProcessNumber');
            processIdEl = document.getElementById('processId');
            duplicityErrorEl = document.getElementById('duplicityError');
            processSubmitButtonEl = document.getElementById('processSubmitButton');
            
            // Referências do Form de Cadastro
            inputAuthorEl = document.getElementById('inputAuthor'); 
            inputDefendantEl = document.getElementById('inputDefendant'); 

            // Referências DOM do Modal de Edição de Processo
            editProcessModal = document.getElementById('editProcessModal');
            editProcessIdEl = document.getElementById('editProcessId');
            modalProcessNumberEl = document.getElementById('modalProcessNumber');
            editStatusEl = document.getElementById('editStatus');
            editDateNominationEl = document.getElementById('editDateNomination');
            editDateDeadlineEl = document.getElementById('editDateDeadline');
            editObservationsEl = document.getElementById('editObservations');
            editAuthorEl = document.getElementById('editAuthor');
            editDefendantEl = document.getElementById('editDefendant');
            
            // NOVO: Referências DOM do Modal de Edição de Credenciais
            editCredentialsModal = document.getElementById('editCredentialsModal');
            editCredentialNameEl = document.getElementById('editCredentialName');
            editCredentialRegistryEl = document.getElementById('editCredentialRegistry');


            // 2. Carrega Dados do Local Storage e Renderiza
            loadCredentials(); 
            renderCredentials(); 
            loadProcesses();
            // renderProcesses é chamado dentro de loadProcesses
            

            // 3. Adiciona Event Listeners
            filterTypeEl?.addEventListener('change', renderProcesses);
            filterStatusEl?.addEventListener('change', renderProcesses);
            searchQueryEl?.addEventListener('keyup', renderProcesses);
            
            if (inputProcessNumberEl) {
                inputProcessNumberEl.addEventListener('input', validateProcessNumber);
            }

            // Garante que o estado inicial do botão de submissão está correto
            validateProcessNumber(); 

        }

        // Expõe initApp para o escopo global (window)
        window.initApp = initApp;
    </script>
</body>
</html>
